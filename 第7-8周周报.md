# 第七周周报

**日期:** 2025年4月12日

## 本周工作总结

本周在 SeuYacc 项目上取得了显著进展，重点围绕冲突处理、语义动作支持、LR 分析表生成与调试以及代码生成等方面展开。主要工作内容和成果如下：

### 1. 冲突处理与优先级/结合性支持

*   **问题识别:** 在处理 `test.y` 文件时发现，若不使用 `%left`, `%right`, `%nonassoc` 等指令明确指定操作符的优先级和结合性，会导致移入/规约冲突。
*   **冲突检测:** 修改了 LR(1) 分析表生成逻辑，增加了对移入/规约冲突和规约/规约冲突的显式检测和报告机制，取代了之前简单的覆盖策略。
*   **Parser 增强:** 扩展了 `YaccParser`，使其能够解析 `%left`, `%right`, `%nonassoc` 声明，并将解析出的优先级和结合性信息存储到符号表 (`symbol_table`) 和产生式 (`Production`) 结构中。
*   **数据结构更新:** 相应地更新了 `Symbol` 和 `Production` 数据结构，增加了存储优先级 (`precedence`) 和结合性 (`assoc`) 的成员。

### 2. 语义动作支持

*   **需求分析:** 为了进行更全面的功能测试和最终生成抽象语法树 (AST)，需要支持 Yacc 文件中的语义动作。
*   **Parser 实现:** 修改了 `YaccParser` 中的产生式解析逻辑 (`parseProduction`)，使其能够识别并提取嵌入在 `{}` 中的语义动作字符串。目前实现仅支持出现在产生式最右侧的语义动作。
*   **数据结构更新:** 在 `Production` 结构中增加了 `semantic_action` 成员，用于存储提取出的语义动作代码。
*   **代码生成集成:** 在 `LRGenerator::generateParserCode` 中，为 `yy_reduce` 函数生成了 `switch` 语句，根据规约的规则编号执行相应的语义动作代码。同时，实现了 `processSemanticAction` 函数，用于将语义动作中的 `$$` 和 `$N` 替换为生成的 C 代码中对应的变量 (`yyval` 和 `yyvsp[N]`)。

### 3. LR 分析表生成与调试增强

*   **Markdown 导出:** 实现了将生成的 ACTION 表和 GOTO 表导出为 Markdown 格式的功能 (`LRGenerator::toMarkdownTable`)。这极大地提高了调试效率，使得分析表的结构和内容可视化，便于检查和定位问题。
*   **字面量处理改进:**
    *   **Parser 修正:** 修复了 `YaccParser` 中对字面量处理的多个问题，确保在解析优先级声明 (`parseAssociativity`) 和产生式符号 (`parseSymbol`) 时，能正确识别单引号包裹的字面量，并从符号表中获取其预定义的属性（如优先级、结合性）。
    *   **分析表结构调整:** 参照官方 Yacc/Bison 的做法，调整了 `LRGenerator::getSortedTerminals` 函数，在生成的 ACTION 表中为 ASCII 字面量预留了前 256 个索引位置（0 为 EOF，1-255 为 ASCII 字符），Token 从索引 256 开始。这保证了生成的代码中 Token 值与官方工具的一致性。
    *   **Markdown 输出优化:** 优化了 Markdown 表格的输出，采用两行表头（第一行为列序号，第二行为符号名），并只显示实际用到的终结符列，使得表格在包含完整信息的同时更加紧凑。

### 4. 代码生成与兼容性测试

*   **头文件与源文件生成:** 模仿官方 Yacc 的输出，实现了生成 `.tab.h` (头文件) 和 `.tab.c` (解析器源文件) 的功能。头文件包含 Token 定义、`YYSTYPE` 联合体定义等；源文件包含解析表 (`yytable`, `yygoto` 等)、`yyparse` 函数、`yy_reduce` 函数以及用户代码。
*   **细节调整与调试:** 在生成代码的过程中，对栈管理 (`stack`, `state_stack`)、GOTO 表查询逻辑、`yy_reduce` 函数的实现等进行了多次调试和修正，解决了 GOTO 表访问错误、栈指针重复调整等问题。
*   **兼容性验证:** 使用官方 Flex 处理 `test.l` 文件生成词法分析器，然后分别使用官方 Yacc 和我们自己的 SeuYacc 处理 `test.y` 文件生成解析器。通过对比运行结果（包括 AST 生成），验证了对于 `test.y` 语法，SeuYacc 生成的解析器与官方 Yacc 生成的解析器行为一致，证明了我们实现的等效性和对语义动作的正确支持。

## 遇到的问题及解决方案

*   **移入/规约冲突:** 通过实现优先级和结合性声明的解析与应用解决。
*   **GOTO 表查询错误:** 通过修正 `yyparse` 函数中规约操作后的栈顶状态恢复逻辑解决。
*   **栈管理错误:** 通过明确 `yy_reduce` 和 `yyparse` 的职责，统一在 `yyparse` 中进行栈顶指针调整解决。
*   **语义动作执行问题:** 通过修正 `yy_reduce` 中对值栈元素的访问方式以及 `processSemanticAction` 中对 `$$`/`$N` 的替换逻辑解决。
*   **字面量处理不当:** 通过修改 `YaccParser` 和 `LRGenerator` 中对字面量的识别、属性获取和在分析表中的索引分配方式解决。

## 下周计划

*   **性能优化 (可选):** 调研并考虑引入 LALR(1) 算法，通过合并具有相同核心项的 LR(1) 状态来减少状态数量，从而缩小生成的解析表体积，提高解析效率。
*   **项目收尾:** 整理代码，完善文档，准备最终的项目报告和演示。

## 总结

本周工作量饱满，核心功能基本完成。SeuYacc 现在能够处理包含优先级/结合性声明和语义动作的 Yacc 文件，生成功能正确的 LR(1) 解析器代码，并具备了更好的调试支持。与官方工具在测试用例上的兼容性也得到了验证。后续将主要进行性能优化探索和项目收尾工作。
